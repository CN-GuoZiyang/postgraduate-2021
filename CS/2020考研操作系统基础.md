## 1 操作系统的基本概念

### 1.1 概念（定义）

操作系统是指控制和管理整个计算机系统的硬件和软件资源，并合理地组织调度计算机的工作和资源的分配，以提供给用户和其它软件方便的接口和环境，它是计算机系统中最基本的系统软件。

1. 操作系统是系统资源的管理者
2. 向上层提供方便易用的服务
3. 是最接近硬件的一层软件

### 1.2 功能和目标

#### 1.2.1 作为系统资源的管理者

1. 处理器管理
2. 存储器管理
3. 文件管理
4. 设备管理

#### 1.2.2 向上层提供方便易用的服务

封装思想，将底层的硬件功能封装成简单易用的服务

提供的服务：

- GUI（Graphical User Interface）
- 命令接口，联机命令接口和脱机命令接口。联机命令接口=交互式命令接口，脱机命令接口=批处理命令接口
- 程序接口，即系统调用，只能通过程序代码间接使用

有时，命令接口和程序接口统称为用户接口

#### 1.2.3 最接近硬件的层次

需要实现对硬件机器的拓展。

没有任何软件支持的计算机称为裸机，覆盖了软件的机器称为扩充机器，或虚拟机。

### 1.3 四个特征

并发，共享，虚拟，异步。

并发和共享是两个最基本的特征，互为存在条件

#### 1.3.1 并发

两个或多个事件在同一时间间隔内发生，这些事件在宏观上同时，在微观上交替

并行是同时发生

操作系统的并发性指计算机同时运行着多个程序，操作系统是伴随着“多道程序技术”出现的，因此操作系统和程序并发是一起诞生的。

注意：单核CPU同一时刻只能执行一个程序，程序只能并发执行；多核CPU同一时刻克同时执行多个程序，程序可以并行地执行。

并发性是操作系统的基本特性

#### 1.3.2 共享

资源共享，系统资源可供内存中多个并发执行的进程共同使用。

两种方式：互斥共享方式和同时共享方式

互斥共享方式：一个时间段内只允许一个进程访问该资源。

同时共享方式：允许一个时间段内多个进程“同时”（宏观上）对它们进行访问。

#### 1.3.3 并发与共享的关系

如果失去并发性，则系统只用一个程序正在运行，则共享性失去存在的意义

如果失去共享性，则不通程序无法同时使用资源，无法实现并发

#### 1.3.4 虚拟

把物理上的实体变为若干逻辑上的对应物，物理实体是实际存在的，逻辑对应物是用户感受到的。

如虚拟处理器技术（时分复用技术）和虚拟存储器技术（空分复用技术）

没有并发性，谈不上虚拟性

#### 1.3.5 异步

在多道程序环境下，允许多个程序并发执行，但由于资源有限，进程的执行不是一贯到底的，而是走走停停，以不可预知的速度向前推进。

只有系统拥有并发性，才有可能导致异步性。

## 2 操作系统的发展与分类

### 2.1 手工操作阶段

打孔程序，装取纸带、读写纸带速度慢，计算速度快，用户独占，资源效率低下

### 2.2 批处理阶段

#### 2.2.1 单道批处理系统

引入脱机输入/输出技术（外围机+磁带），由监督程序负责控制作业的输入输出

计算机直接向磁带上IO，速度快

监督程序是操作系统的雏形

内存中只有一道程序在运行，CPU有大量的时间在等待IO

#### 2.2.2 多道批处理系统

操作系统诞生

计算的同时可以进行IO，支持多道程序并发允许

没有人机交互功能，响应时间长

### 2.3 分时操作系统

计算机以时间片为单位轮流给各个用户/作业服务，各个用户可通过终端与计算机交互

用户请求可以被即时响应，解决了人际交互的问题，用户操作相对独立

不能有限处理一些紧急任务

### 2.4 实时操作系统

能优先响应一些紧急的任务，某些紧急任务不需要时间片排队

计算机系统接收到外部信号后及时进行处理，且要在严格的时限内处理完事件

及时性和可靠性

### 2.5 其它操作系统

网络操作系统，分布式操作系统，个人计算机操作系统

## 3 操作系统的运行环境

### 3.1 运行机制

#### 3.1.1 内核程序 VS 应用程序

普通程序就是应用程序

为了实现操作系统而编写的程序称为内核程序，内核程序组成操作系统内核，简称内核，内核是操作系统最重要最核心的部分，也是最接近硬件的部分

Docker -> 仅需Linux内核

内核作为管理者，可能会让CPU执行特权指令，如：内存清零指令，这些指令只允许内核使用。CPU在设计和生产时已经划分了特权与非特权指令，CPU在执行一条指令前就能判断其类型。

#### 3.1.2 内核态 VS 用户态

CPU判断此时运行程序类型的依据

CPU的两种状态，内核态和用户态，当处于内核态时，说明此时运行的是内核程序，可以执行特权指令，若处于用户态，则运行的是应用程序，只能执行非特权指令

CPU中的一个寄存器，程序状态字寄存器（PSW），其中有一个二进制位，1表示内核态，0表示用户态（不一定）

别名：内核态=核心态=管态，用户态=目态

转换：内核态CPU可执行一条特权指令将CPU状态转换为用户态（主动让出），用户态程序执行时若遇到异常，会触发一个中断信号，使CPU变为核心态，并停止当前应用程序，执行中断处理程序（强制夺回）。

### 3.2 中断和异常

#### 3.2.1 中断的作用

中断是操作系统内核夺回CPU使用权的唯一途径，如果没有中断机制，那么应用程序一旦在CPU上运行，就会一直运行下去，无法实现并发

内核态 -> 用户态：执行一条特权指令——修改PSW的标志位为用户态（主动让出）

用户态 -> 内核态：由中断引发，硬件自动完成变态过程

#### 3.2.2 中断的类型

内中断与外中断

内中断与当前执行的指令有关，中断信号来源于CPU内部

外中断与当前执行的指令无关，中断信号来源于CPU外部

例如，应用程序请求操作系统内核服务，会执行一条指令——陷入指令，该指令会引发一个内部中断信号。（系统调用）

时钟中断，来自时钟部件发来的信号，外中断

I/O中断，由输入/输出设备发来的中断信号

内中断又称为异常，外中断也称为中断

#### 3.2.3 中断的分类

陷阱、陷入（trap），故障（fault），终止（abort）

陷阱、陷入：陷入指令引发，故意引发

故障：错误条件引起，可能被修复，修复完成后可以继续运行，如缺页故障

终止：由致命错误引起，内核程序无法修复该错误，直接终止应用程序，如除零异常、非法使用特权指令

#### 3.2.4 中断机制的基本原理

不同的中断信号，需要不同的中断处理程序来处理。

中断向量表记录了中断处理程序在内存中的存放位置。

中断处理程序是一种内核程序，运行在内核态下。

### 3.3 系统调用

#### 3.3.1 概念

系统调用是操作系统提供给应用程序使用的接口，可以理解为一种可供应用程序调用的特殊函数，应用程序可以通过系统调用来请求获得操作系统内核的服务。

#### 3.3.2 系统调用的功能

1. 设备管理：完成设备的请求/释放/启动等功能
2. 文件管理：完成文件等读/写/创建/删除等功能
3. 进程控制：完成进程的创建/撤销/阻塞/唤醒等功能
4. 进程通信：完成进程之间的消息传递/信号传递等功能
5. 内存管理：完成内存的分配/回收等功能

与共享资源有关的操作，都必须通过系统调用的方式向操作系统内核提供请求

#### 3.3.3 系统调用的过程

