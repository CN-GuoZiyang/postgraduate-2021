# 一 操作系统概述

## 1 操作系统的基本概念

### 1.1 概念（定义）

操作系统是指控制和管理整个计算机系统的硬件和软件资源，并合理地组织调度计算机的工作和资源的分配，以提供给用户和其它软件方便的接口和环境，它是计算机系统中最基本的系统软件。

1. 操作系统是系统资源的管理者
2. 向上层提供方便易用的服务
3. 是最接近硬件的一层软件

### 1.2 功能和目标

#### 1.2.1 作为系统资源的管理者

1. 处理器管理
2. 存储器管理
3. 文件管理
4. 设备管理

#### 1.2.2 向上层提供方便易用的服务

封装思想，将底层的硬件功能封装成简单易用的服务

提供的服务：

- GUI（Graphical User Interface）
- 命令接口，联机命令接口和脱机命令接口。联机命令接口=交互式命令接口，脱机命令接口=批处理命令接口
- 程序接口，即系统调用，只能通过程序代码间接使用

有时，命令接口和程序接口统称为用户接口

#### 1.2.3 最接近硬件的层次

需要实现对硬件机器的拓展。

没有任何软件支持的计算机称为裸机，覆盖了软件的机器称为扩充机器，或虚拟机。

### 1.3 四个特征

并发，共享，虚拟，异步。

并发和共享是两个最基本的特征，互为存在条件

#### 1.3.1 并发

两个或多个事件在同一时间间隔内发生，这些事件在宏观上同时，在微观上交替

并行是同时发生

操作系统的并发性指计算机同时运行着多个程序，操作系统是伴随着“多道程序技术”出现的，因此操作系统和程序并发是一起诞生的。

注意：单核CPU同一时刻只能执行一个程序，程序只能并发执行；多核CPU同一时刻克同时执行多个程序，程序可以并行地执行。

并发性是操作系统的基本特性

#### 1.3.2 共享

资源共享，系统资源可供内存中多个并发执行的进程共同使用。

两种方式：互斥共享方式和同时共享方式

互斥共享方式：一个时间段内只允许一个进程访问该资源。

同时共享方式：允许一个时间段内多个进程“同时”（宏观上）对它们进行访问。

#### 1.3.3 并发与共享的关系

如果失去并发性，则系统只用一个程序正在运行，则共享性失去存在的意义

如果失去共享性，则不通程序无法同时使用资源，无法实现并发

#### 1.3.4 虚拟

把物理上的实体变为若干逻辑上的对应物，物理实体是实际存在的，逻辑对应物是用户感受到的。

如虚拟处理器技术（时分复用技术）和虚拟存储器技术（空分复用技术）

没有并发性，谈不上虚拟性

#### 1.3.5 异步

在多道程序环境下，允许多个程序并发执行，但由于资源有限，进程的执行不是一贯到底的，而是走走停停，以不可预知的速度向前推进。

只有系统拥有并发性，才有可能导致异步性。

## 2 操作系统的发展与分类

### 2.1 手工操作阶段

打孔程序，装取纸带、读写纸带速度慢，计算速度快，用户独占，资源效率低下

### 2.2 批处理阶段

#### 2.2.1 单道批处理系统

引入脱机输入/输出技术（外围机+磁带），由监督程序负责控制作业的输入输出

计算机直接向磁带上IO，速度快

监督程序是操作系统的雏形

内存中只有一道程序在运行，CPU有大量的时间在等待IO

#### 2.2.2 多道批处理系统

操作系统诞生

计算的同时可以进行IO，支持多道程序并发允许

没有人机交互功能，响应时间长

### 2.3 分时操作系统

计算机以时间片为单位轮流给各个用户/作业服务，各个用户可通过终端与计算机交互

用户请求可以被即时响应，解决了人际交互的问题，用户操作相对独立

不能有限处理一些紧急任务

### 2.4 实时操作系统

能优先响应一些紧急的任务，某些紧急任务不需要时间片排队

计算机系统接收到外部信号后及时进行处理，且要在严格的时限内处理完事件

及时性和可靠性

### 2.5 其它操作系统

网络操作系统，分布式操作系统，个人计算机操作系统

## 3 操作系统的运行环境

### 3.1 运行机制

#### 3.1.1 内核程序 VS 应用程序

普通程序就是应用程序

为了实现操作系统而编写的程序称为内核程序，内核程序组成操作系统内核，简称内核，内核是操作系统最重要最核心的部分，也是最接近硬件的部分

Docker -> 仅需Linux内核

内核作为管理者，可能会让CPU执行特权指令，如：内存清零指令，这些指令只允许内核使用。CPU在设计和生产时已经划分了特权与非特权指令，CPU在执行一条指令前就能判断其类型。

#### 3.1.2 内核态 VS 用户态

CPU判断此时运行程序类型的依据

CPU的两种状态，内核态和用户态，当处于内核态时，说明此时运行的是内核程序，可以执行特权指令，若处于用户态，则运行的是应用程序，只能执行非特权指令

CPU中的一个寄存器，程序状态字寄存器（PSW），其中有一个二进制位，1表示内核态，0表示用户态（不一定）

别名：内核态=核心态=管态，用户态=目态

转换：内核态CPU可执行一条特权指令将CPU状态转换为用户态（主动让出），用户态程序执行时若遇到异常，会触发一个中断信号，使CPU变为核心态，并停止当前应用程序，执行中断处理程序（强制夺回）。

### 3.2 中断和异常

#### 3.2.1 中断的作用

中断是操作系统内核夺回CPU使用权的唯一途径，如果没有中断机制，那么应用程序一旦在CPU上运行，就会一直运行下去，无法实现并发

内核态 -> 用户态：执行一条特权指令——修改PSW的标志位为用户态（主动让出）

用户态 -> 内核态：由中断引发，硬件自动完成变态过程

#### 3.2.2 中断的类型

内中断与外中断

内中断与当前执行的指令有关，中断信号来源于CPU内部

外中断与当前执行的指令无关，中断信号来源于CPU外部

例如，应用程序请求操作系统内核服务，会执行一条指令——陷入指令，该指令会引发一个内部中断信号。（系统调用）

时钟中断，来自时钟部件发来的信号，外中断

I/O中断，由输入/输出设备发来的中断信号

内中断又称为异常，外中断也称为中断

#### 3.2.3 中断的分类

陷阱、陷入（trap），故障（fault），终止（abort）

陷阱、陷入：陷入指令引发，故意引发

故障：错误条件引起，可能被修复，修复完成后可以继续运行，如缺页故障

终止：由致命错误引起，内核程序无法修复该错误，直接终止应用程序，如除零异常、非法使用特权指令

#### 3.2.4 中断机制的基本原理

不同的中断信号，需要不同的中断处理程序来处理。

中断向量表记录了中断处理程序在内存中的存放位置。

中断处理程序是一种内核程序，运行在内核态下。

### 3.3 系统调用

#### 3.3.1 概念

系统调用是操作系统提供给应用程序使用的接口，可以理解为一种可供应用程序调用的特殊函数，应用程序可以通过系统调用来请求获得操作系统内核的服务。

#### 3.3.2 系统调用的功能

1. 设备管理：完成设备的请求/释放/启动等功能
2. 文件管理：完成文件等读/写/创建/删除等功能
3. 进程控制：完成进程的创建/撤销/阻塞/唤醒等功能
4. 进程通信：完成进程之间的消息传递/信号传递等功能
5. 内存管理：完成内存的分配/回收等功能

与共享资源有关的操作，都必须通过系统调用的方式向操作系统内核提供请求

#### 3.3.3 系统调用的过程

1. 传参指令，传递必要的参数，指明系统调用的类型，以及其它必要参数
2. 陷入指令，引发内中断信号，CPU进入内核态，并转入响应的中断处理程序，即系统调用的入口程序
3. 入口程序根据寄存器中的参数判断系统调用服务的类型，并调用相应系统调用的处理程序

注意：陷入指令是在用户态执行的，引发内中断，使CPU进入核心态

别名：陷入指令=trap指令=访管指令

### 3.4 操作系统的体系结构

操作系统内核可分为**时钟管理、中断处理、原语**、进程管理、存储器管理、设备管理等功能。

原语（设备驱动、CPU切换等）是一种特殊的程序，具有原子性，不可被中断。

分类：大内核、微内核

微内核仅包括时钟管理、中断处理、原语，而大内核还包括进程管理、存储管理、设备管理等

内核包括等模块需要运行在内核态，其它模块都运行在用户态

切换状态是有成本的，频繁地切换状态会降低系统性能

# 二 进程管理

## 1 进程与线程

### 1.1 进程的概念、组成、特征

#### 1.1.1 进程的概念

程序：静态的，存放在磁盘里的可执行文件，指令集合

进程：动态的，程序的一次执行过程

#### 1.1.2 进程的组成

PID：进程ID（Process ID），唯一的，不重复的

UID：进程所属用户ID

操作系统需要记录PID、UID、分配的资源（内存、IO、文件）、运行情况（CPU使用时间、磁盘使用情况、网络流量）

这些信息会被保存在一个数据结构PCB（Process Control Block）中，即进程控制块

PCB是进程存在的唯一标志，与进程共同创建共同销毁

PCB的组成：

- 进程描述信息：PID、UID
- 进程控制和管理信息：CPU、磁盘、网络使用情况统计，进程当前状态（就绪态、阻塞态、运行态）
- 资源分配清单：正在使用的文件、内存区域、IO设备
- 处理器相关信息：PSW、PC等寄存器的值（用于实现进程切换）

进程的组成：PCB、程序段（程序的代码，指令序列）、数据段（运行过程中产生的数据，如程序定义的变量）

PCB是给操作系统用的，程序段、数据段是给进程自己用的

进程实体（进程映像、快照）是由PCB、程序段、数据段组成，进程是动态的，进程实体是静态的

进程是进程实体的运行过程，是系统进行资源分配和调度的一个独立单位

#### 1.1.3 进程的特征

- 动态性（最基本）：进程是程序的一次执行过程，是动态地产生、变化和消亡的
- 并发性：内存中有多个进程实体，各进程可并发执行
- 独立性：进程是能独立运行、独立获得资源、独立接受调度的基本单位
- 异步性：各进程按各自独立的、不可预知的速度向前推进，操作系统提供“进程同步机制”来解决异步问题
- 结构性：每个进程都会配置一个PCB。结构上看，进程由程序段、数据段、PCB组成

### 1.2 进程的状态与转换

#### 1.2.1 状态

- 创建态：进程正在被创建，该阶段操作系统为进程分配资源、初始化PCB
- 就绪态：创建完成后，进入就绪态，具备运行条件，没有空闲CPU
- 运行态：在CPU上运行，CPU执行该进程对应的程序
- 阻塞态：进程在请求等待某个事件的发生（资源分配，其它进程的响应），无法继续执行，操作系统会让该进程下CPU，进入阻塞态
- 终止态：进程执行exit系统调用，请求操作系统终止该进程，进程进入终止态，操作系统会让该进程下CPU，回收内存空间等资源，回收PCB

基本状态：运行态，就绪态，阻塞态

别名：阻塞态=等待态，创建态=新建态，终止态=结束态

在PCB中，有变量state表示进程当前的状态

#### 1.2.2 状态转换

![](http://ww4.sinaimg.cn/large/006tNc79gy1g5pq9el9szj30jo0bjn3c.jpg)

#### 1.2.3 进程的组织方式

链接方式

分为三个指针（队列）

- 执行指针：指向当前处于运行态（执行态）的进程，单CPU计算机中，同一时刻只会有一个进程处于运行态
- 就绪队列指针：指向当前处于就绪态的进程，通常会把优先级高的进程放在队头
- 阻塞状态指针：指向处于阻塞状态的进程，有时会因为阻塞原因的不同而分为多个队列

索引方式：

索引表

### 1.3 进程控制

#### 1.3.1 概念

对系统中所有进程实施有效的管理，如创建新进程、撤销已有进程、实现进程状态转换等

#### 1.3.2 实现

使用原语实现，执行具有原子性，不可中断

原语使用“关中断指令”和“开中断指令”这两个特权指令来实现原子性

关中断指令使得CPU不再例行检查中断信号，直到执行开中断指令后才会恢复。

##### 1.3.2.1 相关原语

创建原语：即创建一个进程时使用的原语

- 申请空白PCB
- 为新进程分配所需资源
- 初始化PCB
- 将PCB插入就绪队列

引起进程创建的事件：

- 用户登录
- 作业调度
- 提供服务
- 应用请求

撤销原语：终止一个进程所需的原语

- 从PCB集合中找到终止进程的PCB
- 若程序正在执行，剥夺CPU，将CPU分配给其它进程
- 终止其所有子进程
- 将该进程拥有的所有资源归还给父进程或操作系统
- 删除PCB

引起进程终止的事件：

- 正常结束（exit系统调用）
- 异常结束（除0，强行使用特权指令）
- 外界干预（用户手动）

阻塞原语：

- 找到要阻塞的进程对应的PC吧
- 保护进程运行现场，将PCB状态信息设置为“阻塞态”，暂时停止进程运行
- 将PCB插入相应事件的等待队列

引起进程阻塞的事件：

- 需要等待系统分配某种资源
- 需要等待相互合作的其它进程完成工作

唤醒原语：

- 在事件等待队列中找到PCB
- 将PCB从等待队列移除，设置进程为就绪态
- 将PCB插入就绪队列，等待被调度

引起进程唤醒的事件：

- 等待的事件发生（因何事被阻塞，就因何事被唤醒）

切换原语：

- 将运行环境信息存入PCB
- PCB移入相应队列
- 选择另一个进程执行，并更新其PCB
- 根据PCB恢复新进程所需的运行环境

引起进程切换的事件：

- 当前进程时间片结束
- 有更高优先级的进程到达
- 当前进程主动阻塞
- 当前进程终止

CPU中的重要寄存器：

PSW：程序状态字寄存器

PC：程序计数器，存放下一条指令地址

IR：指令寄存器，存放当前正在执行的指令

### 1.4 进程通信

#### 1.4.1 概念

进程之间的信息交换

由于进程是分配系统资源的单位，因此各进程拥有的内存地址空间相互独立

为了保证安全，一个进程无法直接访问另一个进程的地址空间

#### 1.4.2 共享存储

操作系统提供共享空间，两个进程都可读写，以实现通信

两个进程对共享空间的访问必须是互斥的，操作系统提供同步互斥工具（如P、V操作）

分为：基于数据结构的共享和基于存储区的共享

基于数据结构的共享：共享空间只能存放固定的数据结构，速度慢，限制多，低级

基于存储区的共享：数据形式、存放位置由进程提供，速度快，高级

#### 1.4.3 管道通信

“管道”是指用于连接读写进程的一个共享文件，又名pipe文件，其实就是在内存中开辟一个大小固定的缓冲区

注意：

1. 管道只能采用半双工通信，某一时间段内只能实现单向的传输，如果要实现双向同时通信，则需要两个管道
2. 各进程需要互斥地访问管道
3. 数据以字符流的形式写入管道，当管道写满时，写进程的write()系统调用将被阻塞，等待读进程将数据取走，当读进程将数据全部取走后，管道变空，此时读进程的read()系统调用将被阻塞
4. 如果没有写满，则不允许读，反正同理
5. 数据一旦被读出，就会被抛弃，意味着读进程最多只有一个

#### 1.4.4 消息传递

以格式化的消息为单位，进程通过操作系统提供的“发送/接收消息”两个原语进行数据交换

消息分为消息头和消息体，消息头包括：发送进程ID，接收进程ID，消息类型，消息长度等

消息传递分为：直接通信方式和间接通信方式

直接通信方式：消息直接挂到接收进程的消息缓冲队列尾

间接通信方式：消息要先发送到中间实体（信箱）中，因此也被称为“信箱通信方式”

### 1.5 线程的概念与特点

